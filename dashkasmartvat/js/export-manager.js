/**
 * SmartVat Export Handler - Fraub√ºller Style
 * –ú–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
 * @author IT AI SOLAR Team - Leanid, Dashka, Jimmy
 * @version 2.0 Enhanced - English Code + Deutsche Kommentare
 */

class ExportHandler {
    constructor() {
        this.initialized = false;
    }

    init() {
        if (this.initialized) return;
        this.initialized = true;
        console.log('üì§ Export Handler initialized - Fraub√ºller Style');
    }

    // Hauptexport-Funktion mit Men√º
    exportDeclaration() {
        const choice = prompt(`üì§ SmartVat Export - W√§hlen Sie das Format:

1 - üìä Excel/CSV (Tabelle mit allen Daten)
2 - üíæ JSON (Vollst√§ndige Datenstruktur)  
3 - üñ®Ô∏è Drucken (PDF √ºber Browser)
4 - üìã Zwischenablage (F√ºr E-Mail/Chat)

Geben Sie die Nummer ein (1-4):`);

        switch(choice) {
            case '1': this.exportToExcel(); break;
            case '2': this.exportToJSON(); break;
            case '3': this.printDeclaration(); break;
            case '4': this.copyToClipboard(); break;
            default: 
                if (choice !== null) {
                    alert('‚ùå Ung√ºltige Auswahl. Bitte verwenden Sie 1-4');
                }
        }
    }

    // Excel/CSV Export mit deutscher Struktur - –ò–°–ü–†–ê–í–õ–ï–ù–û –ø–æ–¥ –≤–∞—à—É –ª–æ–≥–∏–∫—É
    exportToExcel() {
        if (!window.smartVatCalculator) {
            alert('‚ùå Rechner nicht initialisiert');
            return;
        }

        const data = window.smartVatCalculator.exportData();
        
        // CSV-Daten —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ—á–Ω–æ –ø–æ –í–ê–®–ò–ú –ø–æ–ª—è–º
        const csvData = [
            ['SmartVat Enhanced - Umsatzsteuervoranmeldung'],
            ['√úbertragungsprotokoll'],
            [''],
            [data.company.name],
            [data.company.address],
            ['Steuernummer: ' + data.company.steuernummer],
            ['HRB: ' + data.company.hrb],
            ['Anmeldezeitraum: ' + data.period],
            ['Erstellt am: ' + new Date().toLocaleString('de-DE')],
            [''],
            ['=== LIEFERUNGEN UND LEISTUNGEN ==='],
            ['Feld', 'Beschreibung', 'Betrag (EUR)'],
            ['40a', '–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –ù–î–° –≤–Ω—É—Ç—Ä–∏ –ì–µ—Ä–º–∞–Ω–∏–∏', data.data.field40a],
            ['40b', '–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –ù–î–° –≤–Ω—É—Ç—Ä–∏ –ì–µ—Ä–º–∞–Ω–∏–∏', data.data.field40b],
            ['41', '–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –ï–≤—Ä–æ—Å–æ—é–∑–∞ (–ß–µ—Ö–∏—è, –ü–æ–ª—å—à–∞, –ù–æ—Ä–≤–µ–≥–∏—è)', data.data.field41],
            ['43', '–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Ç—Ä–µ—Ç—å–∏ —Å—Ç—Ä–∞–Ω—ã (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)', data.data.field43],
            ['4', '–û–ë–©–ê–Ø –í–´–†–£–ß–ö–ê –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏', data.data.field4],
            [''],
            ['=== –ü–†–ò–û–ë–†–ï–¢–ï–ù–ò–Ø ==='],
            ['81a', '–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –≤ –ì–µ—Ä–º–∞–Ω–∏–∏ (–Ω–µ—Ç—Ç–æ –±–µ–∑ –ù–î–°)', data.data.field81a],
            ['81b', '–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥ –±–µ–∑ –ù–î–° –≤ –ì–µ—Ä–º–∞–Ω–∏–∏', data.data.field81b],
            ['89a', '–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –ï–° –ø–æ 0% –ù–î–°', data.data.field89a],
            ['89b', '–ò–º–ø–æ—Ä—Ç–Ω—ã–µ –ø–æ—à–ª–∏–Ω—ã', data.data.field89b],
            ['8', '–û–ë–©–ò–ï –ó–ê–¢–†–ê–¢–´ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏', data.data.field8],
            [''],
            ['=== –ù–î–° –†–ê–°–ß–ï–¢–´ ==='],
            ['66', '–ù–î–° —Å–æ —Å—Ç—Ä–æ–∫–∏ 40a (19%)', data.data.field66],
            ['61', '–ò–º–ø–æ—Ä—Ç–Ω—ã–π –ù–î–° –ï–° —Ç–æ–≤–∞—Ä–∞', data.data.field61],
            ['67', '–ù–î–° —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ç—Ä–µ—Ç—å–∏—Ö —Å—Ç—Ä–∞–Ω', data.data.field67],
            ['62', '–û–ë–©–ò–ô –ó–ê–ß–ï–¢–ù–´–ô –ù–î–° (66+61+67)', data.data.field62],
            [''],
            ['=== –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ ==='],
            ['83', '–ù–î–° –ö –î–û–ü–õ–ê–¢–ï/–í–û–ó–í–†–ê–¢–£ (66-62)', data.data.field83],
            ['PROFIT', '–ü–õ–ê–ù–û–í–ê–Ø –ü–†–ò–ë–´–õ–¨ (4-8)', data.data.plannedProfit],
            [''],
            ['=== –§–û–†–ú–£–õ–´ –†–ê–°–ß–ï–¢–ê ==='],
            ['–ü–æ–ª–µ 4:', '40a + 40b + 41 + 43'],
            ['–ü–æ–ª–µ 8:', '81a + 81b + 89a + 89b'],
            ['–ü–æ–ª–µ 66:', '40a √ó 19%'],
            ['–ü–æ–ª–µ 61:', '(89a + 89b) √ó 19%'],
            ['–ü–æ–ª–µ 62:', '66 + 61 + 67'],
            ['–ü–æ–ª–µ 83:', '66 - 62'],
            ['Profit:', '4 - 8'],
            [''],
            ['Software:', data.software],
            ['Export-Zeitstempel:', data.timestamp]
        ];

        // CSV-Datei erstellen und herunterladen
        const filename = `SmartVat_${data.company.name.replace(/[^a-zA-Z0-9]/g, '_')}_${data.period.replace(/\s/g, '_')}.csv`;
        this.downloadCSV(csvData, filename);
        
        alert(`üìä Excel/CSV Export erfolgreich!
        
Datei: ${filename}

‚úÖ Kann in Excel/LibreOffice ge√∂ffnet werden
üìã Alle Felder nach IHRER Logik mit Formeln
üá©üá™ Deutsche Formatierung mit EUR-W√§hrung`);
    }

    // JSON Export f√ºr Entwickler/API
    exportToJSON() {
        if (!window.smartVatCalculator) {
            alert('‚ùå Rechner nicht initialisiert');
            return;
        }

        const exportData = window.smartVatCalculator.exportData();
        
        // Zus√§tzliche Metadaten hinzuf√ºgen
        exportData.meta = {
            version: '2.0.1',
            style: 'Fraub√ºller Enhanced',
            exported_by: 'SmartVat Enhanced',
            team: 'IT AI SOLAR - Leanid, Dashka, Jimmy',
            format: 'JSON',
            compatibility: 'ERIC, ELSTER, SmartVat',
            calculation_logic: 'field83 = field66 - field62; profit = field4 - field8'
        };

        const jsonString = JSON.stringify(exportData, null, 2);
        const filename = `SmartVat_Data_${exportData.company.name.replace(/[^a-zA-Z0-9]/g, '_')}_${exportData.period.replace(/\s/g, '_')}.json`;
        
        this.downloadFile(jsonString, filename, 'application/json');
        
        alert(`üíæ JSON Export erfolgreich!

Datei: ${filename}

‚úÖ Vollst√§ndige Datenstruktur nach IHRER Logik
üîÑ Import-/Export-f√§hig  
üîó API-kompatibel
üìã Alle Berechnungen und Metadaten`);
    }

    // Drucken f√ºr PDF-Export
    printDeclaration() {
        // Kontrollelemente f√ºr Druck ausblenden
        const controls = document.querySelector('.controls');
        const badge = document.querySelector('.smartvat-badge');
        
        const originalControlsDisplay = controls?.style.display || '';
        const originalBadgeDisplay = badge?.style.display || '';
        
        if (controls) controls.style.display = 'none';
        if (badge) badge.style.display = 'none';

        // Druck-spezifische Styles hinzuf√ºgen
        const printStyles = document.createElement('style');
        printStyles.id = 'print-styles';
        printStyles.textContent = `
            @media print {
                body { background: white !important; }
                .document { 
                    box-shadow: none !important; 
                    margin: 0 !important;
                    max-width: none !important;
                }
                .watermark { display: none !important; }
                .field-input { 
                    border: 1px solid #000 !important;
                    background: white !important;
                }
                .smartvat-enhanced {
                    border-left: 2px solid #000 !important;
                    background: #f9f9f9 !important;
                }
            }
        `;
        document.head.appendChild(printStyles);

        // Druckdialog √∂ffnen
        window.print();

        // Nach dem Drucken: Originalzustand wiederherstellen
        setTimeout(() => {
            if (controls) controls.style.display = originalControlsDisplay;
            if (badge) badge.style.display = originalBadgeDisplay;
            
            const printStylesEl = document.getElementById('print-styles');
            if (printStylesEl) printStylesEl.remove();
        }, 1000);

        alert(`üñ®Ô∏è Druckdialog ge√∂ffnet!

üí° Tipp: W√§hlen Sie "Als PDF speichern" f√ºr eine PDF-Datei
üìÑ Alle SmartVat-Erweiterungen sind im Ausdruck enthalten
‚úÖ Bereit f√ºr Steuerberater oder Finanzamt`);
    }

    // In Zwischenablage kopieren
    async copyToClipboard() {
        if (!window.smartVatCalculator) {
            alert('‚ùå Rechner nicht initialisiert');
            return;
        }

        const data = window.smartVatCalculator.exportData();
        
        // Zusammenfassung f√ºr Zwischenablage erstellen - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–¥ –≤–∞—à—É –ª–æ–≥–∏–∫—É
        const summary = `
üöÄ SmartVat Enhanced - Umsatzsteuervoranmeldung
${data.company.name} | ${data.period}

üí∞ –ì–õ–ê–í–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:
Feld 83 (–ö –¥–æ–ø–ª–∞—Ç–µ/–≤–æ–∑–≤—Ä–∞—Ç—É): ${data.data.field83} EUR
–ü–ª–∞–Ω–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å: ${data.data.plannedProfit} EUR

üìä –í–´–†–£–ß–ö–ê (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ):
40a - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –ù–î–° –≤ –ì–µ—Ä–º–∞–Ω–∏–∏: ${data.data.field40a} EUR
40b - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –ù–î–° –≤ –ì–µ—Ä–º–∞–Ω–∏–∏: ${data.data.field40b} EUR
41 - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –ï–°: ${data.data.field41} EUR  
43 - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Ç—Ä–µ—Ç—å–∏ —Å—Ç—Ä–∞–Ω—ã: ${data.data.field43} EUR
4 - –û–ë–©–ê–Ø –í–´–†–£–ß–ö–ê: ${data.data.field4} EUR

üí∏ –ó–ê–¢–†–ê–¢–´ (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ):
81a - –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –≤ –ì–µ—Ä–º–∞–Ω–∏–∏: ${data.data.field81a} EUR
81b - –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –±–µ–∑ –ù–î–° –≤ –ì–µ—Ä–º–∞–Ω–∏–∏: ${data.data.field81b} EUR
89a - –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –≤ –ï–°: ${data.data.field89a} EUR
89b - –ò–º–ø–æ—Ä—Ç–Ω—ã–µ –ø–æ—à–ª–∏–Ω—ã: ${data.data.field89b} EUR
8 - –û–ë–©–ò–ï –ó–ê–¢–†–ê–¢–´: ${data.data.field8} EUR

üßæ –ù–î–° (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ):
66 - –ù–î–° —Å–æ —Å—Ç—Ä–æ–∫–∏ 40a: ${data.data.field66} EUR
61 - –ò–º–ø–æ—Ä—Ç–Ω—ã–π –ù–î–° –ï–°: ${data.data.field61} EUR
67 - –ù–î–° –∏–∑ —Ç—Ä–µ—Ç—å–∏—Ö —Å—Ç—Ä–∞–Ω: ${data.data.field67} EUR
62 - –û–ë–©–ò–ô –ó–ê–ß–ï–¢–ù–´–ô –ù–î–°: ${data.data.field62} EUR

üìê –§–û–†–ú–£–õ–´:
field83 = field66 - field62 = ${data.data.field66} - ${data.data.field62}
profit = field4 - field8 = ${data.data.field4} - ${data.data.field8}

üìÖ Erstellt: ${new Date().toLocaleString('de-DE')}
üîß Software: ${data.software}
        `.trim();

        try {
            await navigator.clipboard.writeText(summary);
            alert(`üìã Daten in Zwischenablage kopiert!

‚úÖ Bereit zum Einf√ºgen in:
‚Ä¢ E-Mail an Steuerberater
‚Ä¢ WhatsApp/Telegram
‚Ä¢ Notizen-App
‚Ä¢ Andere Anwendungen

Der Text enth√§lt alle wichtigen Zahlen nach IHRER Logik.`);
        } catch (err) {
            // Fallback f√ºr √§ltere Browser
            const textArea = document.createElement('textarea');
            textArea.value = summary;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            alert('üìã Daten kopiert (Fallback-Methode)!');
        }
    }

    // Hilfsfunktionen f√ºr Datei-Download
    downloadCSV(data, filename) {
        // CSV-Inhalt mit BOM f√ºr deutsche Umlaute erstellen
        let csvContent = data.map(row => 
            row.map(cell => {
                const cellStr = String(cell).replace(/"/g, '""');
                return `"${cellStr}"`;
            }).join(',')
        ).join('\n');

        // BOM f√ºr korrekte Anzeige deutscher Zeichen hinzuf√ºgen
        const BOM = '\uFEFF';
        csvContent = BOM + csvContent;

        this.downloadFile(csvContent, filename, 'text/csv;charset=utf-8;');
    }

    downloadFile(content, filename, mimeType) {
        // Universelle Datei-Download-Funktion
        const blob = new Blob([content], { type: mimeType });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
    }
}

// Globale Instanz
let exportHandler;

// HTML-kompatible Funktionen  
function exportDeclaration() {
    exportHandler?.exportDeclaration();
}

function printDeclaration() {
    exportHandler?.printDeclaration();
}

function exportToExcel() {
    exportHandler?.exportToExcel();
}

function exportToJSON() {
    exportHandler?.exportToJSON();
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        exportHandler = new ExportHandler();
        window.exportHandler = exportHandler; // Globaler Zugriff
        exportHandler.init();
    }, 300);
});

console.log("‚úÖ Export Handler Module v2.0 Enhanced ‚Äî ready");